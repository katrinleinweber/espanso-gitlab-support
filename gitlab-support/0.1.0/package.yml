# See https://gitlab.com/gitlab-com/support/toolbox/espanso

name: gitlab-support
parent: default

global_vars:
  - name: "clipboard"
    type: "clipboard"

matches:

  # GitLabSOS & KubeSOS
  - trigger: '/glsar'
    replace: 'shortly after reproducing the problem once more.'
  - trigger: "[gsos"
    replace: "[run our `GitLabSOS` script](https://gitlab.com/gitlab-com/support/toolbox/gitlabsos#run-the-script) {{glsar}}"
    vars:
      - name: glsar
        type: match
        params:
          trigger: '/glsar'
  - trigger: "[ksos"
    replace: "[run our `KubeSOS` script](https://gitlab.com/gitlab-com/support/toolbox/kubesos#kubesos) {{glsar}}"
    vars:
      - name: glsar
        type: match
        params:
          trigger: '/glsar'

  # Add Support- & Review Guideline-related quick actions
  # See https://about.gitlab.com/handbook/engineering/ux/technical-writing/#designated-technical-writers,
  # https://docs.gitlab.com/ee/development/code_review.html#dogfooding-the-reviewers-feature,
  # and https://about.gitlab.com/handbook/support/engineering/#support-team-contributions
  - trigger: "/stc"
    replace: "/label ~\"Support Team Contributions\"\n/assign me\n/assign_reviewer @\n/milestone %14."


  # Components of verbose Markdown links, see below
  - trigger: '/glt'
    replace: "{{title}}"
    vars:
      - name: "clipboard"
        type: "clipboard"
      - name: title
        type: shell
        params:
          cmd: 'ruby "$(espanso path packages)"/gitlab-support/title.rb ${ESPANSO_CLIPBOARD}'
  - trigger: '/glr'
    replace: "{{refer}}"
    vars:
      - name: "clipboard"
        type: "clipboard"
      - name: refer
        type: shell
        params:
          cmd: 'ruby "$(espanso path packages)"/gitlab-support/reference.rb ${ESPANSO_CLIPBOARD}'

  # Format verbose issue/MR/epics links in Markdown (nested triggers from above)
  - trigger: '[tr)'
    replace: "[{{title}} ({{refer}})]({{clipboard}})"
    vars:
      - name: "clipboard"
        type: "clipboard"
      - name: title
        type: match
        params:
          trigger: '/glt'
      - name: refer
        type: match
        params:
          trigger: '/glr'
  - trigger: '[rt)'
    replace: "[{{refer}} ({{title}})]({{clipboard}})"
    vars:
      - name: "clipboard"
        type: "clipboard"
      - name: title
        type: match
        params:
          trigger: '/glt'
      - name: refer
        type: match
        params:
          trigger: '/glr'
  - trigger: '[r)'
    replace: "[{{refer}}]({{clipboard}})"
    vars:
      - name: "clipboard"
        type: "clipboard"
      - name: refer
        type: match
        params:
          trigger: '/glr'


  # Customer comments for issues after internal requests
  #   1. copy internal URL into clipboard
  #   2. summarize / partial-quote if necessary/useful
  - trigger: "~cc"
    replace: "A customer [internally]({{clipboard}}) is $|$:\n\n> "
  - trigger: "~pcc"
    replace: "A ~\"GitLab Premium\" customer [internally]({{clipboard}}) is $|$:\n\n> "
  - trigger: "~ucc"
    replace: "A ~\"GitLab Ultimate\" customer [internally]({{clipboard}}) is $|$:\n\n> "
  - trigger: "~lpcc"
    replace: "A large ~\"GitLab Premium\" customer [internally]({{clipboard}}) is $|$:\n\n> "
  - trigger: "~lucc"
    replace: "A large ~\"GitLab Ultimate\" customer [internally]({{clipboard}}) is $|$:\n\n> "

  - trigger: '[sst'
    replace: "See [Slack thread]({{clipboard}})\n\n> $|$"
    vars:
      - name: "clipboard"
        type: "clipboard"

  # filenames & paths
  - trigger: '.gcy'
    replace: '.gitlab-ci.yml'
  - trigger: '/eg'
    replace: '/etc/gitlab/'
  - trigger: '.grb'
    replace: 'gitlab.rb'
  - trigger: '.gsj'
    replace: 'gitlab-secrets.json'

  # Omnibus paths
  #   https://docs.gitlab.com/ee/administration/logs.html
  #   https://docs.gitlab.com/ee/raketasks/backup_restore.html
  - trigger: '/vlg'
    replace: '/var/log/gitlab/'
  - trigger: '/og'
    replace: '/opt/gitlab/'
  - trigger: '/ebg'
    replace: "{{og}}embedded/bin/git"
    vars:
      - name: og
        type: match
        params:
          trigger: '/og'
  - trigger: '/vog'
    replace: "/var{{og}}"
    vars:
      - name: og
        type: match
        params:
          trigger: '/og'
  - trigger: '/vob'
    replace: "{{vog}}backups"
    vars:
      - name: vog
        type: match
        params:
          trigger: '/vog'
  - trigger: '/vodr'
    replace: "{{vog}}git-data/repositories/{{clipboard}}"
    vars:
      - name: vog
        type: match
        params:
          trigger: '/vog'

  # https://docs.gitlab.com/omnibus/maintenance/index.html
  - trigger: '/gctl'
    replace: 'sudo gitlab-ctl tail | tee /tmp/gl-{{clipboard}}-$|$.txt'
  - trigger: '/glcf'
    replace: 'sudo gitlab-ctl reconfigure'
  - trigger: '/glst'
    replace: 'sudo gitlab-ctl status'
  - trigger: '/glrt'
    replace: 'sudo gitlab-ctl restart'
  - trigger: '/glsp'
    replace: 'sudo gitlab-ctl stop'

  # Shell commands for use in SSH sessions on support-resources
  - trigger: '&sde'
    replace: 'shutdown && exit'
  - trigger: '/glsri'
    replace: |
      # Support-Resource initialization with a minimal configuration,
      # pinned version & some useful configs
      GRB=/etc/gitlab/gitlab.rb

      # Block Gravatar
      sudo echo '127.0.0.1 gravatar.com' >> /etc/hosts

      # Clear config file & insert a few useful items
      sudo sed \
          -e 's/#.*$//;/^$/d' \
          --in-place=.ori \
          $GRB && \
      echo "gitlab_rails['usage_ping_enabled'] = false" >> $GRB && \
      echo "logging['logrotate_frequency'] = nil" >> $GRB && \
      echo "logging['logrotate_size'] = '5G'" >> $GRB && \
      sudo gitlab-ctl reconfigure

      apt install --yes ripgrep jq

      sudo apt-mark hold {*g,g}itlab* && \
      sudo apt --yes upgrade
      sudo reboot


  # Miscellaneous

  - trigger: "*(Q"
    replace: "**(Q$|$)**"

  - trigger: "(urg"
    replace: "([using `ripgrep` there](https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md))"

  - trigger: "[Rc"
    replace: "[Rails console](https://docs.gitlab.com/ee/administration/operations/rails_console.html)"

  - trigger: "<ds"
    replace: "<details><summary>$|$</summary>{{clipboard}}</details>"

  - trigger: ':tfe'
    replace: ':thread: for emergency :point_up:'
